<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Thread Tree Navigator - Legal Review</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/primeng@17.0.0/resources/themes/lara-light-blue/theme.css">
    <link rel="stylesheet" href="https://unpkg.com/primeng@17.0.0/resources/primeng.min.css">
    <link rel="stylesheet" href="https://unpkg.com/primeicons@6.0.1/primeicons.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
        }

        /* Top Navigator with Visualization */
        .top-navigator {
            background: white;
            border-bottom: 2px solid #e0e4e7;
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 120px;
            max-height: 180px;
        }

        .nav-title {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .nav-subtitle {
            font-size: 14px;
            color: #64748b;
        }

        .nav-stats {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 16px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .stat-number {
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
        }

        .stat-label {
            font-size: 12px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Main Content Area */
        .main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* Layout Grid */
        .layout-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 8px;
            padding: 8px;
            width: 100%;
            height: 100%;
        }

        /* Panel Styling */
        .panel {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .panel-header {
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 48px;
        }

        .panel-title {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
        }

        .panel-content {
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        /* Tree Visualization */
        .tree-container {
            width: 100%;
            height: 100%;
            overflow: auto;
        }

        .tree-svg {
            width: 100%;
            height: 100%;
            min-height: 300px;
        }

        .node {
            cursor: pointer;
        }

        .node circle {
            fill: #3b82f6;
            stroke: #1e40af;
            stroke-width: 2px;
        }

        .node text {
            font: 12px sans-serif;
            fill: #374151;
        }

        .link {
            fill: none;
            stroke: #6b7280;
            stroke-width: 2px;
        }

        /* Timeline */
        .timeline-container {
            padding: 16px;
            overflow-y: auto;
        }

        .timeline-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .timeline-item:last-child {
            border-bottom: none;
        }

        .timeline-marker {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #3b82f6;
            margin-right: 12px;
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-subject {
            font-size: 13px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 2px;
        }

        .timeline-meta {
            font-size: 11px;
            color: #64748b;
        }

        /* Thread List */
        .thread-list {
            padding: 16px;
            overflow-y: auto;
        }

        .thread-item {
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .thread-item:hover {
            border-color: #3b82f6;
            background: #f8fafc;
        }

        .thread-item.selected {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .thread-subject {
            font-size: 13px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 4px;
        }

        .thread-participants {
            font-size: 11px;
            color: #64748b;
            margin-bottom: 2px;
        }

        .thread-count {
            font-size: 11px;
            color: #3b82f6;
            font-weight: 500;
        }

        /* Analytics */
        .analytics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            padding: 16px;
            height: 100%;
            overflow-y: auto;
        }

        .analytics-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 12px;
        }

        .analytics-title {
            font-size: 12px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .analytics-value {
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
        }

        .analytics-subtitle {
            font-size: 10px;
            color: #64748b;
        }

        /* Loading States */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #64748b;
            font-size: 14px;
        }

        .error {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #dc2626;
            font-size: 14px;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Main App Component
        function EmailThreadNavigator() {
            const [threadData, setThreadData] = useState(null);
            const [selectedThread, setSelectedThread] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            useEffect(() => {
                loadThreadData();
            }, []);

            const loadThreadData = async () => {
                try {
                    const response = await fetch('thread_report.json');
                    if (!response.ok) {
                        throw new Error('Failed to load thread data');
                    }
                    const data = await response.json();
                    setThreadData(data);

                    // Select first thread by default
                    const threads = Object.entries(data.threads);
                    if (threads.length > 0) {
                        setSelectedThread(threads[0][1]);
                    }
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            if (loading) {
                return (
                    <div className="app-container">
                        <div className="loading">Loading email thread data...</div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="app-container">
                        <div className="error">
                            Error loading thread data: {error}
                            <br />
                            Please ensure thread_report.json exists in the same directory.
                        </div>
                    </div>
                );
            }

            return (
                <div className="app-container">
                    <TopNavigator summary={threadData.summary} />
                    <MainContent
                        threads={threadData.threads}
                        selectedThread={selectedThread}
                        onThreadSelect={setSelectedThread}
                    />
                </div>
            );
        }

        // Top Navigator Component
        function TopNavigator({ summary }) {
            return (
                <div className="top-navigator">
                    <div>
                        <div className="nav-title">Email Thread Analysis</div>
                        <div className="nav-subtitle">Solr Data - Hybrid Threading</div>
                    </div>
                    <div className="nav-stats">
                        <div className="stat-item">
                            <div className="stat-number">{summary.totalEmails}</div>
                            <div className="stat-label">Emails</div>
                        </div>
                        <div className="stat-item">
                            <div className="stat-number">{summary.totalThreads}</div>
                            <div className="stat-label">Threads</div>
                        </div>
                        <div className="stat-item">
                            <div className="stat-number">{(summary.totalEmails / summary.totalThreads).toFixed(1)}</div>
                            <div className="stat-label">Avg/Thread</div>
                        </div>
                    </div>
                </div>
            );
        }

        // Main Content Component
        function MainContent({ threads, selectedThread, onThreadSelect }) {
            const threadEntries = Object.entries(threads);
            const sortedThreads = threadEntries.sort((a, b) => b[1].totalEmails - a[1].totalEmails);

            return (
                <div className="main-content">
                    <div className="layout-grid">
                        <ThreadListPanel
                            threads={sortedThreads}
                            selectedThread={selectedThread}
                            onThreadSelect={onThreadSelect}
                        />
                        <ThreadVisualizationPanel thread={selectedThread} />
                        <ThreadTimelinePanel thread={selectedThread} />
                        <ThreadAnalyticsPanel thread={selectedThread} />
                    </div>
                </div>
            );
        }

        // Thread List Panel
        function ThreadListPanel({ threads, selectedThread, onThreadSelect }) {
            return (
                <div className="panel">
                    <div className="panel-header">
                        <div className="panel-title">Conversation Threads</div>
                    </div>
                    <div className="panel-content">
                        <div className="thread-list">
                            {threads.map(([threadId, thread]) => (
                                <div
                                    key={threadId}
                                    className={`thread-item ${selectedThread?.threadId === threadId ? 'selected' : ''}`}
                                    onClick={() => onThreadSelect(thread)}
                                >
                                    <div className="thread-subject">
                                        {truncateText(threadId, 40)}
                                    </div>
                                    <div className="thread-participants">
                                        {thread.participantCount} participants
                                    </div>
                                    <div className="thread-count">
                                        {thread.totalEmails} emails
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        // Thread Visualization Panel
        function ThreadVisualizationPanel({ thread }) {
            const svgRef = useRef();

            useEffect(() => {
                if (thread && svgRef.current) {
                    drawThreadTree(svgRef.current, thread);
                }
            }, [thread]);

            if (!thread) {
                return (
                    <div className="panel">
                        <div className="panel-header">
                            <div className="panel-title">Thread Visualization</div>
                        </div>
                        <div className="panel-content">
                            <div className="loading">Select a thread to view visualization</div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="panel">
                    <div className="panel-header">
                        <div className="panel-title">Thread Structure</div>
                    </div>
                    <div className="panel-content">
                        <div className="tree-container">
                            <svg ref={svgRef} className="tree-svg"></svg>
                        </div>
                    </div>
                </div>
            );
        }

        // Timeline Panel
        function ThreadTimelinePanel({ thread }) {
            if (!thread) {
                return (
                    <div className="panel">
                        <div className="panel-header">
                            <div className="panel-title">Timeline</div>
                        </div>
                        <div className="panel-content">
                            <div className="loading">Select a thread to view timeline</div>
                        </div>
                    </div>
                );
            }

            // Create mock timeline items
            const timelineItems = Array.from({ length: thread.totalEmails }, (_, i) => ({
                id: i,
                subject: `Email ${i + 1}`,
                date: new Date(thread.dateRange.start).toLocaleDateString(),
                participant: thread.participants[i % thread.participants.length] || 'Unknown'
            }));

            return (
                <div className="panel">
                    <div className="panel-header">
                        <div className="panel-title">Email Timeline</div>
                    </div>
                    <div className="panel-content">
                        <div className="timeline-container">
                            {timelineItems.map((item) => (
                                <div key={item.id} className="timeline-item">
                                    <div className="timeline-marker"></div>
                                    <div className="timeline-content">
                                        <div className="timeline-subject">{item.subject}</div>
                                        <div className="timeline-meta">
                                            {cleanParticipant(item.participant)} • {item.date}
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        // Analytics Panel
        function ThreadAnalyticsPanel({ thread }) {
            if (!thread) {
                return (
                    <div className="panel">
                        <div className="panel-header">
                            <div className="panel-title">Analytics</div>
                        </div>
                        <div className="panel-content">
                            <div className="loading">Select a thread to view analytics</div>
                        </div>
                    </div>
                );
            }

            const daySpan = Math.ceil(
                (new Date(thread.dateRange.end) - new Date(thread.dateRange.start)) / (1000 * 60 * 60 * 24)
            );

            return (
                <div className="panel">
                    <div className="panel-header">
                        <div className="panel-title">Thread Analytics</div>
                    </div>
                    <div className="panel-content">
                        <div className="analytics-grid">
                            <div className="analytics-card">
                                <div className="analytics-title">Duration</div>
                                <div className="analytics-value">{daySpan}</div>
                                <div className="analytics-subtitle">days</div>
                            </div>
                            <div className="analytics-card">
                                <div className="analytics-title">Participants</div>
                                <div className="analytics-value">{thread.participantCount}</div>
                                <div className="analytics-subtitle">unique</div>
                            </div>
                            <div className="analytics-card">
                                <div className="analytics-title">Max Depth</div>
                                <div className="analytics-value">{thread.maxDepth}</div>
                                <div className="analytics-subtitle">levels</div>
                            </div>
                            <div className="analytics-card">
                                <div className="analytics-title">Branches</div>
                                <div className="analytics-value">{thread.branchCount}</div>
                                <div className="analytics-subtitle">splits</div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Tree drawing function
        function drawThreadTree(svgElement, thread) {
            const svg = d3.select(svgElement);
            svg.selectAll("*").remove();

            const width = svgElement.clientWidth || 400;
            const height = svgElement.clientHeight || 300;

            const g = svg.append("g")
                .attr("transform", "translate(40,20)");

            // Create simple tree data
            const treeData = {
                name: `Thread (${thread.totalEmails} emails)`,
                children: thread.participants.slice(0, 5).map((participant, i) => ({
                    name: cleanParticipant(participant),
                    value: Math.floor(thread.totalEmails / thread.participantCount)
                }))
            };

            const treeLayout = d3.tree()
                .size([height - 40, width - 80]);

            const root = d3.hierarchy(treeData);
            treeLayout(root);

            // Draw links
            g.selectAll(".link")
                .data(root.links())
                .enter().append("path")
                .attr("class", "link")
                .attr("d", d3.linkHorizontal()
                    .x(d => d.y)
                    .y(d => d.x));

            // Draw nodes
            const node = g.selectAll(".node")
                .data(root.descendants())
                .enter().append("g")
                .attr("class", "node")
                .attr("transform", d => `translate(${d.y},${d.x})`);

            node.append("circle")
                .attr("r", 5);

            node.append("text")
                .attr("dy", "0.31em")
                .attr("x", d => d.children ? -8 : 8)
                .style("text-anchor", d => d.children ? "end" : "start")
                .text(d => truncateText(d.data.name, 20));
        }

        // Utility functions
        function truncateText(text, maxLength) {
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }

        function cleanParticipant(participant) {
            if (!participant || participant === 'Unknown') return 'Unknown';

            if (participant.includes('<') && participant.includes('>')) {
                const name = participant.split('<')[0].trim();
                return name || participant.split('<')[1].split('>')[0];
            }

            if (participant.startsWith('CN=')) {
                return participant.replace(/CN=([^/]+).*/, '$1');
            }

            return participant;
        }

        // Render the app
        ReactDOM.render(<EmailThreadNavigator />, document.getElementById('root'));
    </script>
</body>
</html>